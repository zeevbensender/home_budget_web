# =========================================
# Home Budget Web â€” Backend Makefile
# Milestone 1: FastAPI + PostgreSQL backend
# =========================================

# Variables
COMPOSE = docker compose
SERVICE = backend

# ------------------------------
# ğŸ§± Build the backend container
# ------------------------------
build:
	$(COMPOSE) build

# ------------------------------
# ğŸš€ Start the stack (backend + db)
# ------------------------------
up:
	$(COMPOSE) up

# ------------------------------
# ğŸš€ Start in detached mode
# ------------------------------
up-detached:
	$(COMPOSE) up -d

# ------------------------------
# ğŸ§© Stop and remove containers
# ------------------------------
down:
	$(COMPOSE) down

# ------------------------------
# ğŸ§¹ Stop and remove containers + volumes
# ------------------------------
clean:
	$(COMPOSE) down -v

# ------------------------------
# ğŸ§ª Run tests inside the backend container
# ------------------------------
test:
	$(COMPOSE) run --rm $(SERVICE) poetry run pytest -v

# ------------------------------
# ğŸ” Rebuild from scratch (no cache)
# ------------------------------
rebuild:
	$(COMPOSE) build --no-cache

# ------------------------------
# ğŸ“¦ Database Migrations (Alembic)
# ------------------------------

# Run migrations to latest version
migrate:
	$(COMPOSE) run --rm $(SERVICE) poetry run alembic upgrade head

# Create a new migration (auto-generate from models)
# Usage: make migration MSG="add_user_table"
migration:
	$(COMPOSE) run --rm $(SERVICE) poetry run alembic revision --autogenerate -m "$(MSG)"

# Show current migration status
migrate-status:
	$(COMPOSE) run --rm $(SERVICE) poetry run alembic current

# Show migration history
migrate-history:
	$(COMPOSE) run --rm $(SERVICE) poetry run alembic history

# Downgrade one migration
migrate-down:
	$(COMPOSE) run --rm $(SERVICE) poetry run alembic downgrade -1

# ------------------------------
# ğŸŒ± Seed smoke test data
# ------------------------------
seed-smoke:
	$(COMPOSE) run --rm $(SERVICE) poetry run python scripts/seed_smoke.py