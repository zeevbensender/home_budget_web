# =========================================
# Home Budget Web â€” Backend Makefile
# Milestone 1: FastAPI + PostgreSQL backend
# =========================================

# Variables
COMPOSE = docker compose
SERVICE = backend
DATABASE_URL ?= postgresql://budget:budget@localhost:5432/budget_db

# ------------------------------
# ğŸ§± Build the backend container
# ------------------------------
build:
	$(COMPOSE) build

# ------------------------------
# ğŸš€ Start the stack (backend + db)
# ------------------------------
up:
	$(COMPOSE) up

# ------------------------------
# ğŸš€ Start in detached mode
# ------------------------------
up-detached:
	$(COMPOSE) up -d

# ------------------------------
# ğŸ§© Stop and remove containers
# ------------------------------
down:
	$(COMPOSE) down

# ------------------------------
# ğŸ§¹ Stop and remove containers + volumes
# ------------------------------
clean:
	$(COMPOSE) down -v

# ------------------------------
# ğŸ§ª Run tests inside the backend container
# ------------------------------
test:
	$(COMPOSE) run --rm $(SERVICE) poetry run pytest -v

# ------------------------------
# ğŸ” Rebuild from scratch (no cache)
# ------------------------------
rebuild:
	$(COMPOSE) build --no-cache

# ------------------------------
# ğŸ—„ï¸ Run database migrations
# ------------------------------
migrate:
	DATABASE_URL=$(DATABASE_URL) python -m alembic upgrade head

# ------------------------------
# ğŸŒ± Seed the database with fixture data
# ------------------------------
seed:
	DATABASE_URL=$(DATABASE_URL) python -m scripts.seed

# ------------------------------
# ğŸš€ Full database setup (migrate + seed)
# ------------------------------
db-setup: migrate seed