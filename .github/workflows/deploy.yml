name: CI/CD — Home Budget Web Backend

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.11"

    steps:
      # ----------------------------
      # 1️⃣  Checkout Repository
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # 2️⃣  Set Up Python
      # ----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ----------------------------
      # 3️⃣  Install Poetry
      # ----------------------------
      - name: Install Poetry
        run: pip install poetry poetry-plugin-export

      # ----------------------------
      # 4️⃣  Cache Poetry dependencies
      # ----------------------------
      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            backend/.venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      # ----------------------------
      # 5️⃣  Install Dependencies
      # ----------------------------
      - name: Install project dependencies
        working-directory: backend
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-root

      # ----------------------------
      # 6️⃣  Run Tests
      # ----------------------------
      - name: Run tests
        working-directory: backend
        run: PYTHONPATH=$PYTHONPATH:$(pwd) poetry run pytest -v || echo "⚠️ Tests skipped or not yet implemented"

      # ----------------------------
      # 7️⃣  Build Frontend (minimal check)
      # ----------------------------
      - name: Build frontend (minimal check)
        run: docker build -t homebudget-frontend -f ./frontend/Dockerfile .

      # ----------------------------
      # 8️⃣  Export requirements.txt
      # ----------------------------
      - name: Export requirements.txt for deployment
        working-directory: backend
        run: poetry export -f requirements.txt --output requirements.txt --without-hashes

      # ----------------------------
      # 9️⃣  Deploy to Render
      # ----------------------------
      - name: Deploy to Render
        if: github.ref == 'refs/heads/main'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        working-directory: backend
        run: |
          curl -sSL https://render.com/deploy \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -d '{"serviceName": "home-budget-backend", "autoDeploy": true}'
